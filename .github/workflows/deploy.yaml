name: CI/CD Pipeline - Go App Deployment (GHCR)

on:
  # 监听所有以 'release-' 开头的 Tag 推送事件
  push:
    tags:
      - 'release-*'

# 定义环境变量
env:
  # 使用 GHCR 格式: ghcr.io/GitHub用户名/仓库名称 (必须小写)
  DOCKER_IMAGE_BASE: ghcr.io/${{ github.repository }}
  CONTAINER_NAME: ci-cd-test-container # 部署到服务器上的容器名称

jobs:
  build-and-push:
    name: '1. Build and Push Go Image to GHCR'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须要有 packages: write 权限才能推送 GHCR

    steps:
      - name: 'Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Tag Name (Image Version)
        id: get_tag
        # 提取标签名作为版本号，例如 release-v2.0.0 -> v2.0.0
        run: echo "TAG_VERSION=$(echo ${{ github.ref_name }} | sed 's/release-//')" >> $GITHUB_OUTPUT

      - name: 'Login to GitHub Container Registry (GHCR)'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # 使用 GitHub 自动提供的 TOKEN 进行认证
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Build and Push Docker Image'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 动态生成 Tag
          tags: |
            ${{ env.DOCKER_IMAGE_BASE }}:${{ steps.get_tag.outputs.TAG_VERSION }}
            ${{ env.DOCKER_IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: '2. Deploy to CentOS Server'
    needs: build-and-push # 确保构建成功后才进行部署
    runs-on: ubuntu-latest

    steps:
      - name: 'Get Tag Name (Image Version)'
        id: get_tag
        run: echo "TAG_VERSION=$(echo ${{ github.ref_name }} | sed 's/release-//')" >> $GITHUB_OUTPUT

      - name: 'Deploy via SSH to Server'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            IMAGE_NAME="${{ env.DOCKER_IMAGE_BASE }}:${{ steps.get_tag.outputs.TAG_VERSION }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            echo "--- 正在服务器上拉取新镜像: $IMAGE_NAME ---"
            docker pull $IMAGE_NAME
            echo "--- 部署完成！容器 $CONTAINER_NAME 正在运行 ---"
  #            echo "--- 停止和删除旧容器 (如果存在) ---"
  #            docker stop $CONTAINER_NAME || true
  #            docker rm $CONTAINER_NAME || true
  #            echo "--- 启动新容器 ---"
  #            docker run -d \
  #              --name $CONTAINER_NAME \
  #              -p 80:8080 \
  #              $IMAGE_NAME
#            docker image prune -f